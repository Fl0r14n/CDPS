<!DOCTYPE html>
<html>
    <head>
        <title>CDPS</title>

        <link rel="stylesheet" type="text/css" href="css/custom-theme/jquery-ui-1.10.3.custom.css" >
        <link rel="stylesheet" type="text/css" href="css/main.css"/>
        <link rel="stylesheet" type="text/css" href="css/autocomplete.css"/>
        
        <script src="js/jquery-1.9.1.js"></script>
        <script src="js/jquery-ui-1.10.3.custom.js"></script>
        <script type="text/javascript" src="js/jscolor/jscolor.js"></script>
        <script type="text/javascript" src="js/jquery.autocomplete.min.js"></script>
        
        <script src="http://code.highcharts.com/stock/highstock.js"></script>
        <script src="http://code.highcharts.com/stock/modules/exporting.js"></script>
        
<script>

Date.prototype.yyyymmdd = function() {
   var yyyy = this.getFullYear().toString();
   var mm = (this.getMonth()+1).toString(); // getMonth() is zero-based
   var dd  = this.getDate().toString();
   return yyyy + "-" + (mm[1]?mm:"0"+mm[0]) + "-" + (dd[1]?dd:"0"+dd[0]); // padding
  };


globaldata={};

$(document).ready(function() {
	
	var uid="n/a";
	var personalData;
	var speeddata=[];
	var tempdata=[];
	var pressdata=[];
	
	var fromDate = new Date().yyyymmdd();
	var toDate = new Date().yyyymmdd();
	
	
	chartloaded=false;
	renderChart();
	selectUser();
	
	var chart=$('#container').highcharts();	
	
	$("#w-get-data").on("click",function(){
		if(uid != 'n/a')		    
			getRiskData(fromDate,toDate);
		else
			alert('Select user firstly');
	});
	
	
	function getRiskData(from, to){
		$.ajax({
				url: "/rest/getRiskData?uid=" + uid,
				dataType: "json",
				data: {
					from: from,
					to: to
				},			
				success: function( response) {	
					
					chart.zoomOut(); 
					
					$("#risk").empty();
					
					var out = '<div id="riskBlock"><dl>';
					out += '<dt>' + "Stroke RISK: " + '</dt><dd>' + response.riskFactor + " (" + response.strokeRisk + ")" + '</dd>';  
					out += '<dt>' + "Age RI: " + '</dt><dd>' + response.ageIndex + '</dd>';  
					out += '<dt>' + "Smoking RI: " + '</dt><dd>' + response.smokingIndex + '</dd>';  
					out += '<dt>' + "Diastolic RI: " + '</dt><dd>' + response.diastolicIndex + '</dd>';  
					out += '<dt>' + "Systolic RI: " + '</dt><dd>' + response.systolicIndex + '</dd>';  
					out += '</dl></div>';
		
					$("#risk").append( out );												
					
					dataset=createobjects1(response.sensorData,"diastolicPressure");
					renderChartByMetric(dataset, "Diastolic");
					dataset=createobjects1(response.sensorData,"systolicPressure");
					renderChartByMetric(dataset, "Systolic");
					
				}
			});
    }
	
	function renderChartByMetric(dataset, label){
				dataset.sort(Comparator);
				var series = {	
						id: label,
						name: label,
						data: dataset,
						yAxis: label+"Axis",						
						dataGrouping: {
							enabled: true
							}
				};	
				
				var chartSeries = getseriesbyname(label);
				if (chartSeries === undefined) {
					chart.addSeries(series);					
				}else{
					chartSeries.setData(dataset);
 				}
	}
	
	
	function selectUser(){
			$('#w-input-search').autocomplete({
				serviceUrl: '/rest/getUid',
				paramName: "userName",
				delimiter: ",",
				
				onSelect: function(suggestion){
				 //$(".details").empty();
				 
				uid = suggestion.data.email; 
				$(".details").empty();
		    
					var out = '<dl>';
					out += '<dt>' + "Name: " + '</dt><dd>' + suggestion.data.personalData.name + '</dd>';  
					out += '<dt>' + "Date of birth: " + '</dt><dd>' + new Date(suggestion.data.personalData.dob).yyyymmdd() + '</dd>';  
					out += '<dt>' + "Email: " + '</dt><dd>' + suggestion.data.email + '</dd>';
					out += '</dl>';
					$(".details").append( out );
				},
				
			    transformResult: function(response) {

			        return {
			        	
			            suggestions: $.map($.parseJSON(response), function(item) {			            	
			                return { value: item.personalData.name, data: item };
			            })
			            
			        };
			        
			    }
			});
	}
	
	
	
	$(document).ajaxStart(function(){
		chart.showLoading('Loading data from server...');
	});
		
	$(document).ajaxStop(function(){
		chart.hideLoading();	
	});
	
	
	function createobjects1(obj,metric) {
		var returndata=[];
		//obj = jQuery.parseJSON(obj);
		$(".details1").empty();
		for (var i=0; i<obj.length; i++){
				var myDate = new Date(obj[i].eventDate);
				//$(".details1").append(obj[i].riskInfo);
				var offset = myDate.getTimezoneOffset() * 1000;
				var withOffset = myDate.getTime();
				var withoutOffset = withOffset - offset;
				var basetimestamp = parseInt(withOffset);	
				for (var key in obj[i]) {
					if (key!="id" && key !="eventDate" && key!="riskInfo"){
						timestamp = 0;
						var hour = parseInt(key.substring(1));
						value=parseFloat(obj[i][key][metric]);
						if(!isNaN(value)){
						    timestamp = basetimestamp + parseInt(hour*3600*1000)
							returndata.push([timestamp,value]);
						}
					 }
				}
			}
		return returndata;	
	}
	
	
		
	function Comparator(a,b){
		if (a[0] < b[0]) return -1;
		if (a[0] > b[0]) return 1;
		return 0;
	}
	
	
		function renderChart() {
		
		$('#container').highcharts({
		    chart: {
				backgroundColor: '#EFEFEB',				
				
				events: {
					load: function(chart) {
						chartloaded = true;
						this.setTitle(null, {
						});
						
					}
				},
				zoomType: 'x'
		    },			
			plotOptions: {
				series: {
					marker: {
						enabled: false	
					},
					events: {
						legendItemClick: function () {
							return false; 
						}
					}
				}				
			},
			navigator : {
				//enabled:true
			},
			
			scrollbar: {
				enabled: true
			},
			
			legend: {
				enabled : true,
				title: {text:'Legend'},
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle',
                borderWidth: 0,
				width: 200,
				margin:50,
				useHTML: true
            },

		    

			yAxis:[
				{
				id:"DiastolicAxis",
				title:{
					text:"mmHg"
					}
				},
				{
				id:"SystolicAxis",
				title:{
					text:"mmHg"
					}
				}						
			],
			
			xAxis: {
                type: 'datetime',
                //maxZoom: 14 * 24 * 3600000, // fourteen days				
                title: {
                    text: null
                }
            },

		    title: {
				text: ''
			}
			
			
		});
		
		$(".highcharts-legend").click(function(event){
			event.preventDefault();
			return false;
		})
		
	};

	$("#Diastolic").on("click",function(){
		$(this).find(".icon").toggleClass("add");
		$(this).find(".icon").toggleClass("delete");	
		var series = getseriesbyname("Diastolic");
		if (series.visible){
			series.hide();
			chart.get("BloodPressureAxis").update({				
				title: {
					text: null
				}
			});
		}else {
			series.show();
			chart.get("BloodPressureAxis").update({				
				title:{
					text:"mmHgs"
					}
				});
		}	
	});
	
	$("#Systolic").on("click",function(){	
		$(this).find(".icon").toggleClass("add");
		$(this).find(".icon").toggleClass("delete");	
		var series = getseriesbyname("Systolic");
		if (series.visible){
			series.hide();
			chart.get("SystolicAxis").update({				
				title: {
					text: null
				}
			});
		}else {
			series.show();
			chart.get("SystolicAxis").update({				
				title:{
					text:"mg/L"
					}
				});
		}	
	});
	$("#pressure").on("click",function(){
		$(this).find(".icon").toggleClass("add");
		$(this).find(".icon").toggleClass("delete");	
		var series = getseriesbyname("Pressure");
		if (series.visible){
			series.hide();
			chart.get("PressureAxis").update({				
				title: {
					text: null
				}
			});
		}else {
			series.show();
			chart.get("PressureAxis").update({
				title:{
					text:"Bar"
					}
				});
		}	
	});

	$(".range-selectors input#from").datepicker({
		dateFormat:"M d, yy",
		onSelect: function(){
			fromDate= new Date($(this).val()).yyyymmdd();
			$(".range-selectors input#to").datepicker( "option", "minDate", new Date($(this).val()) );
			//getData("Temp",tempdata,fromDate,toDate,"Diastolic",0)
		}
	});
	
	$(".range-selectors input#to").datepicker({
		dateFormat:"M d, yy",
		onSelect: function(){
			toDate= new Date($(this).val()).yyyymmdd();
			$(".range-selectors input#from").datepicker( "option", "maxDate", new Date($(this).val()) );
			//getData("Temp",tempdata,fromDate,toDate,"Diastolic",0)
		}
	});
	
	$(".range-selectors input#from").datepicker("setDate", new Date() );
	$(".range-selectors input#to").datepicker("setDate", new Date() );
	
	function getseriesbyname(name){
		for(var i=0;i<chart.series.length;i++){			
			if (chart.series[i].name == name)
				return chart.series[i]
		}
	}
	
	$(".color").on("change",function(){
		chart.get($(this).data("series")).update({
			color:$(this).val()
		});
	});
	
	$(".series-type").on("change",function(){
		chart.get($(this).data("series")).update({
			type:$(this).val()
		});
	});
	
});



</script>
</head>

<body>

<div id="wrapper">
	<div id="sidebar">
	<fieldset>
		<legend>Search criteria</legend>
		<fieldset>
		<legend>User</legend>
		<label for="from">User id</label><input type="text"  id="w-input-search" value="">	
		</fieldset>
		<fieldset>
		<legend>Dates</legend>		
			<div class="range-selectors">
			<table>
			<tr>
				<td><label for="from">From</label></td>
				<td><input id="from" type="text"/></td>
			</tr>
			<tr>
				<td><label for="to">To</label></td>
				<td><input id="to" type="text"/></td>
			</tr>	
			</table>
			</div>
		</fieldset>
		<div>
			<span>
				<button id="w-get-data" type="button">Load data</button>
			</span>
		</div>
	</fieldset>		
	<fieldset>
		<legend>Personal data</legend>
		<div class="details">
		</div>
	</fieldset> 
	</div>
	<div id="content">
		<div id="inner-content">
			<h1>Data graph</h1>			
			<div id="container"></div>
			<fieldset>
				<legend>Cardiovascular risks</legend>					
				<div id="risk"></div>
			</fieldset> 
		</div>
	</div>
</div>



</body>

</html>